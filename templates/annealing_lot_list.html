{% extends "base.html" %}
{% block content %}
{# robust admin flag #}
{% set admin =
  (request.state.is_admin is defined and request.state.is_admin) or
  (request.state.role is defined and request.state.role|string == 'admin') or
  (request.state.roles is defined and 'admin' in request.state.roles)
%}

<h2>Annealing Lots</h2>

<div class="toolbar" style="margin-bottom:10px; gap:8px; display:flex; flex-wrap:wrap; align-items:center">
  <a class="btn" href="/anneal/">← Back to Annealing</a>

  <form method="get" action="/anneal/lots" style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
    <label>From</label>
    <input type="date" name="from_date" value="{{ from_date or '' }}">
    <label>To</label>
    <input type="date" name="to_date" value="{{ to_date or '' }}">
    <button class="btn" type="submit">Fetch</button>

    <a class="btn" href="/anneal/lots?from_date={{ today }}&to_date={{ today }}">Today</a>
    <a class="btn" href="/anneal/lots">Reset</a>

    <a class="btn" href="/anneal/lots?csv=1{% if from_date %}&from_date={{ from_date }}{% endif %}{% if to_date %}&to_date={{ to_date }}{% endif %}">Download CSV</a>
  </form>
</div>

<table class="table">
  <tr>
    <th>Date</th><th>Lot</th><th>Grade</th>
    <th>Weight (kg)</th><th>Ammonia (kg)</th>
    {% if admin %}<th>RAP Cost/kg (₹)</th><th>Anneal Cost/kg (₹)</th>{% endif %}
    <th>QA</th><th>Action</th>
  </tr>

  {% for x in lots %}
    {% if x.weight_kg and x.weight_kg > 0 %}
    <tr class="
        {% if x.grade and x.grade.startswith('KIP') %} bg-info-subtle
        {% elif x.grade and x.grade.startswith('KFS') %} bg-warning-subtle
        {% endif %}
    ">
      <td>{{ x.date }}</td>
      <td>{{ x.lot_no }}</td>
      <td>
        <span class="pill
          {% if x.grade and x.grade.startswith('KIP') %} pill-blue
          {% elif x.grade and x.grade.startswith('KFS') %} pill-orange
          {% endif %}
        ">{{ x.grade }}</span>
      </td>
      <td>{{ '%.0f'|format(x.weight_kg) }}</td>
      <td>{{ '%.2f'|format(x.ammonia_kg or 0) }}</td>
      {% if admin %}
        <td>{{ '%.2f'|format(x.rap_cost_per_kg or 0) }}</td>
        <td>{{ '%.2f'|format(x.cost_per_kg or 0) }}</td>
      {% endif %}
      <td>{{ x.qa_status }}</td>
      <td><a class="btn btn-small" href="/anneal/qa/{{ x.id }}">QA</a></td>
    </tr>
    {% endif %}
  {% endfor %}

  <tr class="table-info">
    <th colspan="3">TOTAL</th>
    <th>{{ '%.2f'|format(total_weight) }}</th>
    <th></th>
    {% if admin %}
      <th></th>
      <th>{{ '%.2f'|format(weighted_cost) }}</th>
    {% endif %}
    <th></th>
    <th></th>
  </tr>
</table>

<div class="muted" style="margin-top:6px">
  <span class="pill pill-blue">KIP</span> = KRIP output,
  <span class="pill pill-orange">KFS</span> = KRFS output
</div>

<style>
  .bg-info-subtle    { background-color: #e6f4ff; }
  .bg-warning-subtle { background-color: #fff3e0; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px; font-weight:600; }
  .pill-blue   { background:#d7ebff; }
  .pill-orange { background:#ffe9cf; }
</style>
{% endblock %}
