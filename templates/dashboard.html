{% extends "base.html" %}
{% block content %}

<style>
  :root{--border:#e5e7eb;--muted:#6b7280;--bg:#f9fafb}
  .brand{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand .name{font-weight:700;font-size:22px;margin:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
  .pill{display:inline-block;border:1px solid var(--border);background:#f9fafb;padding:4px 10px;border-radius:999px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  @media (max-width: 1200px){ .grid-3{grid-template-columns:1fr 1fr} }
  @media (max-width: 800px){ .grid-2,.grid-3{grid-template-columns:1fr} }
  .card{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
  .card h2{margin:0 0 6px 0;font-size:16px}
  .muted{color:var(--muted);font-size:12px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--border);padding:6px;text-align:left}
  th{background:#f3f4f6}
  .right{text-align:right}

  /* Print-friendly */
  @media print{
    .toolbar, header.krn-nav, footer{ display:none !important; }
    body{ margin:0; }
    .card{ page-break-inside: avoid; }
  }
</style>

<div class="brand">
  <div class="name">Executive Dashboard — Plant 1</div>
  <img src="/static/KRN_Logo.png" alt="KRN" style="height:42px">
</div>

<div class="toolbar">
  <form method="get" action="/dashboard" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label>From</label>
    <input type="date" name="from_date" max="{{ today }}" value="{{ from_date }}">
    <label>To</label>
    <input type="date" name="to_date"   max="{{ today }}" value="{{ to_date }}">
    <button class="btn">Apply</button>
    <a class="btn" href="/dashboard">This Month</a>
    <span class="pill">Yesterday: {{ yesterday }}</span>
    <span class="pill">Today: {{ today }}</span>
    <span class="pill" title="RM + WIP (Melting/Atom/Anneal/Grind) + RAP + FG. No duplication.">
      Total value in hand: <strong>₹ {{ '%.0f' % (total_value_in_hand or 0) }}</strong>
    </span>
  </form>
  <button class="btn" onclick="window.print()">Print / Save PDF</button>
</div>

<!-- Row A: High-level charts -->
<div class="grid-3">
  <div class="card">
    <h2>Inventory — Value by Stage (₹)</h2>
    <canvas id="invChart" height="160"></canvas>
    <div class="muted" style="margin-top:6px">Snapshot as of today.</div>
  </div>

  <div class="card">
    <h2>Output — Yesterday vs MTD (kg)</h2>
    <canvas id="prodChart" height="160"></canvas>
    <div class="muted" style="margin-top:6px">All production nodes.</div>
  </div>

  <div class="card">
    <h2>Avg Cost/kg (₹) — Anneal · Grind · FG</h2>
    <canvas id="costChart" height="160"></canvas>
    <div class="muted" style="margin-top:6px">Range: {{ from_date }} → {{ to_date }}</div>
  </div>
</div>

<!-- WIP pipeline -->
<div class="card" style="margin-top:14px">
  <h2>WIP Pipeline — RM → FG</h2>
  <canvas id="wipChart" height="180"></canvas>
  <div class="muted" style="margin-top:6px">Snapshot as of {{ today }} (Qty in kg, Value in ₹).</div>
</div>

<!-- Row B: Department snapshots -->
<div class="grid-3" style="margin-top:14px">
  <div class="card">
    <h2>Melting</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ '%.0f' % melt_yday.actual_kg }} kg</td></tr>
      <tr><th>kWh/ton (Y)</th><td class="right">{{ '%.1f' % melt_yday.kwhpt }}</td></tr>
      <tr><th>Yield % (Y)</th><td class="right">{{ '%.1f' % melt_yday.yield_pct }}</td></tr>
      <tr><th>Eff. % (Y vs tgt)</th><td class="right">{{ '%.1f' % melt_yday.eff_pct }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ '%.0f' % melt_mtd.actual_kg }} kg</td></tr>
      <tr><th>Avg kWh/ton</th><td class="right">{{ '%.1f' % melt_mtd.kwhpt }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.MELTING %}<tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>{% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Atomization</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ '%.0f' % atom_yday_prod }} kg</td></tr>
      <tr><th>Eff. % (Y)</th><td class="right">{{ '%.1f' % atom_yday_eff }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ '%.0f' % atom_mtd_prod }} kg</td></tr>
      <tr><th>Avg Eff. %</th><td class="right">{{ '%.1f' % atom_mtd_eff }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.ATOM %}<tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>{% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Annealing</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ '%.0f' % anneal_yday_prod }} kg</td></tr>
      <tr><th>Avg Cost/kg</th><td class="right">₹ {{ '%.2f' % anneal_avg_cost }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ '%.0f' % anneal_mtd_prod }} kg</td></tr>
      <tr><th>Value (MTD)</th><td class="right">₹ {{ '%.0f' % anneal_value }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.ANNEAL %}<tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>{% endfor %}
    </table>
  </div>
</div>

<div class="grid-2" style="margin-top:14px">
  <div class="card">
    <h2>Grinding & Screening</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ '%.0f' % grind_yday_prod }} kg</td></tr>
      <tr><th>Avg Cost/kg</th><td class="right">₹ {{ '%.2f' % grind_avg_cost }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ '%.0f' % grind_mtd_prod }} kg</td></tr>
      <tr><th>Value (MTD)</th><td class="right">₹ {{ '%.0f' % grind_value }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.GRIND %}<tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>{% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Packing & FG / Dispatch</h2>
    <table>
      <tr><th>FG — Yesterday</th><td class="right">{{ '%.0f' % fg_yday_prod }} kg</td></tr>
      <tr><th>FG — Avg Cost/kg</th><td class="right">₹ {{ '%.2f' % fg_avg_cost }}</td></tr>
      <tr><th>FG — MTD Output</th><td class="right">{{ '%.0f' % fg_mtd_prod }} kg</td></tr>
      <tr><th>FG Stock Value (now)</th><td class="right">₹ {{ '%.0f' % fg_stock_value }}</td></tr>
      <tr><th>Dispatch (MTD)</th><td class="right">{{ '%.0f' % dispatch_mtd_qty }} kg | ₹ {{ '%.0f' % dispatch_mtd_value }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3 — FG)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.FG %}<tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>{% endfor %}
    </table>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  const inv  = {{ inv_by_stage   | tojson }};
  const prod = {{ prod_by_stage  | tojson }};
  const cost = {{ cost_by_stage  | tojson }};
  const wip  = {{ wip_pipeline   | tojson }};

  function makeBar(canvasId, labels, v1, v2, label1, label2){
    new Chart(document.getElementById(canvasId), {
      type: 'bar',
      data: {
        labels,
        datasets: [
          ...(v1 ? [{label: label1, data: v1}] : []),
          ...(v2 ? [{label: label2, data: v2}] : []),
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // Inventory value by stage (₹)
  makeBar(
    'invChart',
    inv.map(x=>x.label),
    inv.map(x=>x.value),
    null,
    'Value (₹)'
  );

  // Output — Yesterday vs MTD (kg)
  makeBar(
    'prodChart',
    prod.map(x=>x.label),
    prod.map(x=>x.yday),
    prod.map(x=>x.mtd),
    'Yesterday (kg)','MTD (kg)'
  );

  // Avg cost/kg
  makeBar(
    'costChart',
    cost.map(x=>x.label),
    cost.map(x=>x.avg_cost),
    null,
    'Avg Cost/kg (₹)'
  );

  // WIP pipeline (Qty vs Value)
  new Chart(document.getElementById('wipChart'), {
    type: 'bar',
    data: {
      labels: wip.map(x=>x.label),
      datasets: [
        { label: 'Qty (kg)',  data: wip.map(x=>x.qty)   },
        { label: 'Value (₹)', data: wip.map(x=>x.value) }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true } }
    }
  });
})();
</script>
{% endblock %}
