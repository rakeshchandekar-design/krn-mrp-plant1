{% extends "base.html" %}
{% block content %}

<style>
  :root{--border:#e5e7eb;--muted:#6b7280;--bg:#f9fafb}
  .brand{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .brand .name{font-weight:700;font-size:22px;margin:0}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
  .pill{display:inline-block;border:1px solid var(--border);background:#f9fafb;padding:4px 10px;border-radius:999px}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  @media (max-width:1200px){.grid-3{grid-template-columns:1fr 1fr}.grid-4{grid-template-columns:1fr 1fr}}
  @media (max-width:800px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}

  .card{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
  .card h2{margin:0 0 6px 0;font-size:16px;display:flex;justify-content:space-between;align-items:flex-end;gap:8px}
  .muted{color:var(--muted);font-size:12px}

  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--border);padding:6px;text-align:left}
  th{background:#f3f4f6}
  .right{text-align:right}

  .kpi{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
  .kpi .label{color:#374151}
  .kpi .val{font-weight:700}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* Small figure chips shown next to chart titles */
  .fig{font-size:12px;color:#374151}
  .fig b{font-weight:700}

  /* Chart containers (fixed height for screen & print) */
  .chart-container{height:160px}
  .chart-container.tall{height:180px}

  /* Screen vs print */
  .screen-only{display:block}
  .print-only{display:none}

  @media print{
    @page{size:A4 portrait;margin:12mm}
    html,body{background:#fff}
    header.krn-nav, footer, .toolbar{display:none!important}
    .screen-only{display:none!important}
    .print-only{display:block!important}
    .card{page-break-inside:avoid;break-inside:avoid}
    .grid-2,.grid-3,.grid-4{gap:10px}
    .chart-container,.chart-container.tall,canvas{width:100%!important;height:150px!important}
    *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
</style>

<div class="brand">
  <div class="name">Executive Dashboard</div>
  <img src="/static/KRN_Logo.png" alt="KRN" style="height:42px">
</div>

<!-- PRINT HEADER -->
<div class="print-only" style="border:1px solid var(--border);border-radius:10px;padding:8px;margin:6px 0 10px;background:#fff">
  <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div style="font-weight:700">Executive Dashboard</div>
    <div style="font-size:12px;color:#374151">
      Range: <strong>{{ from_date }}</strong> → <strong>{{ to_date }}</strong> |
      Yesterday: {{ yesterday }} | Today: {{ today }}
    </div>
  </div>
  <div style="margin-top:6px">
    <span style="padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#f9fafb">
      Total value in hand:
      <strong>
        <span class="money" data-rupees="{{ (total_value_in_hand | default(0) | float) }}"></span>
      </strong>
    </span>
  </div>
</div>

<!-- SCREEN TOOLBAR -->
<div class="toolbar screen-only">
  <form method="get" action="/dashboard" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label>From</label>
    <input type="date" name="from_date" max="{{ today }}" value="{{ from_date }}">
    <label>To</label>
    <input type="date" name="to_date" max="{{ today }}" value="{{ to_date }}">
    <button class="btn">Apply</button>
    <a class="btn" href="/dashboard">This Month</a>
    <span class="pill">Yesterday: {{ yesterday }}</span>
    <span class="pill">Today: {{ today }}</span>
    <span class="pill" title="RM + WIP (Melting/Atom/Anneal/Grind) + RAP + FG. No duplication.">
      Total value in hand:
      <strong><span class="money" data-rupees="{{ (total_value_in_hand | default(0) | float) }}"></span></strong>
    </span>
  </form>
  <button class="btn" onclick="window.print()">Print / Save PDF</button>
</div>

<!-- Row A: High-level charts -->
<div class="grid-3">
  <div class="card">
    <h2>
      <span>Inventory — Value by Stage</span>
      <span class="fig" id="invFig"></span>
    </h2>
    <div class="chart-container"><canvas id="invChart"></canvas></div>
    <div class="muted" id="invNote" style="margin-top:6px">Snapshot as of today.</div>
  </div>

  <div class="card">
    <h2>
      <span>Output — Yesterday vs MTD</span>
      <span class="fig" id="prodFig"></span>
    </h2>
    <div class="chart-container"><canvas id="prodChart"></canvas></div>
    <div class="muted" id="prodNote" style="margin-top:6px">All production nodes.</div>
  </div>

  <div class="card">
    <h2>
      <span>Avg Cost/kg — RM → Melting → Atom → Anneal → Grind → FG</span>
      <span class="fig" id="costFig"></span>
    </h2>
    <div class="chart-container"><canvas id="costChart"></canvas></div>
    <div class="muted" style="margin-top:6px">Range: {{ from_date }} → {{ to_date }}</div>
  </div>
</div>

<!-- WIP pipeline (dual axis) -->
<div class="card" style="margin-top:14px">
  <h2>
    <span>WIP Pipeline — RM → FG</span>
    <span class="fig" id="wipFig"></span>
  </h2>
  <div class="chart-container tall"><canvas id="wipChart"></canvas></div>
  <div class="muted" id="wipNote" style="margin-top:6px">Snapshot as of {{ today }}.</div>
</div>

<!-- Row B: Department snapshots -->
<div class="grid-3" style="margin-top:14px">
  <div class="card">
    <h2>Melting</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ (melt_yday.actual_kg | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>kWh/ton (Y)</th><td class="right">{{ (melt_yday.kwhpt | default(0) | float) | round(1) }}</td></tr>
      <tr><th>Yield % (Y)</th><td class="right">{{ (melt_yday.yield_pct | default(0) | float) | round(1) }}</td></tr>
      <tr><th>Eff. % (Y vs tgt)</th><td class="right">{{ (melt_yday.eff_pct | default(0) | float) | round(1) }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ (melt_mtd.actual_kg | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Avg kWh/ton</th><td class="right">{{ (melt_mtd.kwhpt | default(0) | float) | round(1) }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.MELTING | default([]) %}
        <tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>
      {% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Atomization</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ (atom_yday_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Eff. % (Y)</th><td class="right">{{ (atom_yday_eff  | default(0) | float) | round(1) }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ (atom_mtd_prod  | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Avg Eff. %</th><td class="right">{{ (atom_mtd_eff   | default(0) | float) | round(1) }}</td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.ATOM | default([]) %}
        <tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>
      {% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Annealing</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ (anneal_yday_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Avg Cost/kg</th><td class="right">₹ {{ (anneal_avg_cost | default(0) | float) | round(2) }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ (anneal_mtd_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Value (MTD)</th>
        <td class="right"><span class="money" data-rupees="{{ (anneal_value | default(0) | float) }}"></span></td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.ANNEAL | default([]) %}
        <tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>
      {% endfor %}
    </table>
  </div>
</div>

<div class="grid-2" style="margin-top:14px">
  <div class="card">
    <h2>Grinding & Screening</h2>
    <table>
      <tr><th>Yesterday</th><td class="right">{{ (grind_yday_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Avg Cost/kg</th><td class="right">₹ {{ (grind_avg_cost | default(0) | float) | round(2) }}</td></tr>
      <tr><th>MTD Output</th><td class="right">{{ (grind_mtd_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Value (MTD)</th>
        <td class="right"><span class="money" data-rupees="{{ (grind_value | default(0) | float) }}"></span></td></tr>
    </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.GRIND | default([]) %}
        <tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>
      {% endfor %}
    </table>
  </div>

  <div class="card">
    <h2>Packing & FG / Dispatch</h2>
    <table>
      <tr><th>FG — Yesterday</th><td class="right">{{ (fg_yday_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>FG — Avg Cost/kg</th><td class="right">₹ {{ (fg_avg_cost | default(0) | float) | round(2) }}</td></tr>
      <tr><th>FG — MTD Output</th><td class="right">{{ (fg_mtd_prod | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>FG Stock Value (now)</th>
        <td class="right"><span class="money" data-rupees="{{ (fg_stock_value | default(0) | float) }}"></span></td></tr>
      <tr>
        <th>Dispatch (MTD)</th>
        <td class="right">
          {{ (dispatch_mtd_qty | default(0) | float) | round(0) }} kg |
          <span class="money" data-rupees="{{ (dispatch_mtd_value | default(0) | float) }}"></span>
        </td>
      </tr>
     </table>
    <h3 style="margin:8px 0 4px">Downtime (Top-3 — FG)</h3>
    <table>
      <tr><th>Reason</th><th class="right">Min</th></tr>
      {% for r in dt_top3.FG | default([]) %}
        <tr><td>{{ r.reason }}</td><td class="right">{{ r.minutes }}</td></tr>
      {% endfor %}
    </table>
  </div>
</div>

<!-- Row C: New KPIs -->
<div class="grid-3" style="margin-top:14px">
  <div class="card">
    <h2>Atomization — Oversize</h2>
    <div class="kpi"><div class="label">Oversize (Yesterday)</div><div class="val mono">{{ (atom_oversize_y | default(0) | float) | round(0) }} kg</div></div>
    <div class="kpi"><div class="label">Oversize (MTD)</div><div class="val mono">{{ (atom_oversize_m | default(0) | float) | round(0) }} kg</div></div>
    <div class="muted">PSD-derived (&gt;180/212 µm) + Screening 80#.</div>
  </div>

  <div class="card">
    <h2>Anneal — Ammonia & Efficiency</h2>
    <table>
      <tr><th>NH₃ Used (Y)</th><td class="right">{{ (ann_nh3_y | default(0) | float) | round(1) }} kg</td></tr>
      <tr><th>NH₃ Used (MTD)</th><td class="right">{{ (ann_nh3_m | default(0) | float) | round(1) }} kg</td></tr>
      <tr><th>Eff. (Y)</th><td class="right">{{ (ann_eff_y | default(0) | float) | round(1) }} kg/ton</td></tr>
      <tr><th>Eff. (MTD)</th><td class="right">{{ (ann_eff_m | default(0) | float) | round(1) }} kg/ton</td></tr>
    </table>
    <div class="muted">Efficiency = FG out / Grinding input.</div>
  </div>

  <div class="card">
    <h2>Grinding — Oversize & Efficiency</h2>
    <table>
      <tr><th>Oversize 80# (Y)</th><td class="right">{{ (gr_os_y | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Oversize 80# (MTD)</th><td class="right">{{ (gr_os_m | default(0) | float) | round(0) }} kg</td></tr>
      <tr><th>Grinding Eff. (Y)</th><td class="right">{{ (gr_eff_y | default(0) | float) | round(1) }} %</td></tr>
      <tr><th>Grinding Eff. (MTD)</th><td class="right">{{ (gr_eff_m | default(0) | float) | round(1) }} %</td></tr>
    </table>
    <div class="muted">Efficiency = FG out / Grinding input.</div>
  </div>
</div>

<!-- Row D: FG stock by grade + QA -->
<div class="grid-2" style="margin-top:14px">
  <div class="card">
    <h2>FG Stock — Grade-wise (On-hand)</h2>
    <table>
      <tr><th>Grade</th><th class="right">Qty (kg)</th><th class="right">Value</th></tr>
      {% for g in fg_stock_by_grade | default([]) %}
        <tr>
          <td>{{ g.grade }}</td>
          <td class="right">{{ (g.qty | default(0) | float) | round(0) }}</td>
          <td class="right"><span class="money" data-rupees="{{ (g.value | default(0) | float) }}"></span></td>
        </tr>
      {% endfor %}
      {% if (fg_stock_by_grade | default([]) | length) == 0 %}
        <tr><td colspan="3" class="muted">No approved FG on hand.</td></tr>
      {% endif %}
    </table>
  </div>

  <div class="card">
    <h2>QA — Eagle View ({{ from_date }} → {{ to_date }})</h2>
    <table>
      <tr><th>Status</th><th class="right">Heats</th><th class="right">Lots</th></tr>
      {% set q = qa_eagle | default({}) %}
      {% for s in ["PENDING","APPROVED","HOLD","REJECTED"] %}
        {% set hs = "heats_" + s.lower() %}
        {% set ls = "lots_"  + s.lower() %}
        <tr><td>{{ s }}</td><td class="right">{{ q[hs] | default(0) }}</td><td class="right">{{ q[ls] | default(0) }}</td></tr>
      {% endfor %}
    </table>
    <div class="muted">Counts are limited to items created/dated within the selected range.</div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  // ---- Lightweight "value labels" plugin: draw numbers above bars/points ----
  const ValueLabels = {
    id:'valueLabels',
    afterDatasetsDraw(chart, args, opts){
      const {ctx} = chart; ctx.save();
      const fmt = (opts && opts.formatter) ? opts.formatter : (v)=>String(v);
      chart.data.datasets.forEach((ds, di) => {
        const meta = chart.getDatasetMeta(di);
        meta.data.forEach((elem, i) => {
          const raw = ds.data[i]; if (raw == null) return;
          const txt = fmt(raw, di, i, ds, chart);
          ctx.font = '10px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.fillStyle = '#111';
          const y = elem.y - 4;
          ctx.fillText(txt, elem.x, y);
        });
      });
      ctx.restore();
    }
  };
  Chart.register(ValueLabels);

  // ---- Incoming data ----
  const inv  = {{ (inv_by_stage  | default([]))  | tojson }};
  const prod = {{ (prod_by_stage | default([]))  | tojson }};
  const cost = {{ (cost_by_stage | default([]))  | tojson }};
  const wip  = {{ (wip_pipeline  | default([]))  | tojson }};
  const fgByGrade = {{ (fg_stock_by_grade | default([])) | tojson }};

  const fgStockValue   = Number({{ (fg_stock_value      | default(0) | float) }});
  const annVal         = Number({{ (anneal_value        | default(0) | float) }});
  const grVal          = Number({{ (grind_value         | default(0) | float) }});
  const dispVal        = Number({{ (dispatch_mtd_value  | default(0) | float) }});
  const totalInHand    = Number({{ (total_value_in_hand | default(0) | float) }});

  // ---- Unit helpers ----
  function pickMoneyUnit(maxVal){ return (maxVal >= 1e7) ? {div:1e7, label:"₹ Cr"} : {div:1e5, label:"₹ Lakh"}; }
  function moneyNumber(val, M){ return Number(val||0)/M.div; }
  function moneyText(val, M, frac=2){ return `${(Number(val||0)/M.div).toLocaleString('en-IN',{maximumFractionDigits:frac})}`; }

  function pickWeightUnit(maxKg){ return (maxKg >= 1e5) ? {div:1000, label:"MT"} : {div:1, label:"kg"}; }
  function weightNumber(valKg, W){ return Number(valKg||0)/W.div; }
  function weightText(valKg, W, fracMT=1){
    const frac = (W.div===1000) ? fracMT : 0;
    return (Number(valKg||0)/W.div).toLocaleString('en-IN', {maximumFractionDigits: frac});
  }

  // Decide units from overall magnitudes
  const moneyPool = []
    .concat((inv||[]).map(x => Number(x.value||0)))
    .concat((wip||[]).map(x => Number(x.value||0)))
    .concat((fgByGrade||[]).map(x => Number(x.value||0)))
    .concat([fgStockValue, annVal, grVal, dispVal, totalInHand]);
  const MONEY = pickMoneyUnit(Math.max(0, ...moneyPool.filter(Number.isFinite)));

  const prodPool = []
    .concat((prod||[]).map(x => Number(x.yday||0)))
    .concat((prod||[]).map(x => Number(x.mtd ||0)))
    .concat((wip||[]).map(x => Number(x.qty ||0)));
  const WEIGHT = pickWeightUnit(Math.max(0, ...prodPool.filter(Number.isFinite)));

  // Update inline money spans (pills + tables)
  document.querySelectorAll('.money[data-rupees]').forEach(el => {
    const v = Number(el.getAttribute('data-rupees')||0);
    el.textContent = `${MONEY.label} ${moneyText(v, MONEY)}`;
  });

  // ---- Figure chips (totals near titles) ----
  const invTotal = (inv||[]).reduce((s,x)=>s+Number(x.value||0),0);
  const invFig = document.getElementById('invFig');
  if(invFig) invFig.innerHTML = `Total: <b>${MONEY.label} ${moneyText(invTotal, MONEY)}</b>`;
  const invNote = document.getElementById('invNote');
  if(invNote) invNote.textContent = `Snapshot as of today — values shown in ${MONEY.label}.`;

  const prodY = (prod||[]).reduce((s,x)=>s+Number(x.yday||0),0);
  const prodM = (prod||[]).reduce((s,x)=>s+Number(x.mtd ||0),0);
  const prodFig = document.getElementById('prodFig');
  if(prodFig) prodFig.innerHTML = `Y: <b>${weightText(prodY, WEIGHT)}</b> ${WEIGHT.label} • MTD: <b>${weightText(prodM, WEIGHT)}</b> ${WEIGHT.label}`;
  const prodNote = document.getElementById('prodNote');
  if(prodNote) prodNote.textContent = `All production nodes — weights shown in ${WEIGHT.label}.`;

  const costVals = (cost||[]).map(x=>Number(x.avg_cost||0)).filter(Number.isFinite);
  const costAvg = costVals.length ? (costVals.reduce((a,b)=>a+b,0)/costVals.length) : 0;
  const costFig = document.getElementById('costFig');
  if(costFig) costFig.innerHTML = `Avg: <b>₹ ${costAvg.toFixed(2)} / kg</b>`;

  const wipQty = (wip||[]).reduce((s,x)=>s+Number(x.qty||0),0);
  const wipVal = (wip||[]).reduce((s,x)=>s+Number(x.value||0),0);
  const wipFig = document.getElementById('wipFig');
  if(wipFig) wipFig.innerHTML = `Qty: <b>${weightText(wipQty, WEIGHT)}</b> ${WEIGHT.label} • Value: <b>${MONEY.label} ${moneyText(wipVal, MONEY)}</b>`;
  const wipNote = document.getElementById('wipNote');
  if(wipNote) wipNote.textContent = `Snapshot as of {{ today }} — qty in ${WEIGHT.label}, value in ${MONEY.label}.`;

  // ---- Generic chart builder with our value-labels plugin ----
  function makeBar(canvasId, labels, datasetDefs, yTickCb, labelFormatter){
    const el = document.getElementById(canvasId);
    if(!el) return;
    new Chart(el, {
      type:'bar',
      data:{ labels, datasets: datasetDefs },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ top:16 } },
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.formattedValue}` } },
          valueLabels:{ formatter: labelFormatter }
        },
        scales:{ y:{ beginAtZero:true, ticks:{ callback: yTickCb } } }
      }
    });
  }

  // 1) Inventory — value labels per bar in ₹ Lakh/Cr
  (function(){
    const labels = (inv||[]).map(x=>x.label);
    const data   = (inv||[]).map(x=>moneyNumber(x.value||0, MONEY));
    makeBar(
      'invChart',
      labels,
      [{ label:`Value (${MONEY.label})`, data }],
      v => Number(v).toLocaleString('en-IN'),
      raw => `${Number(raw).toLocaleString('en-IN')}`
    );
  })();

  // 2) Output — Yesterday vs MTD with labels in kg/MT
  (function(){
    const labels = (prod||[]).map(x=>x.label);
    const yData  = (prod||[]).map(x=>weightNumber(x.yday||0, WEIGHT));
    const mData  = (prod||[]).map(x=>weightNumber(x.mtd ||0, WEIGHT));
    makeBar(
      'prodChart',
      labels,
      [
        { label:`Yesterday (${WEIGHT.label})`, data:yData, backgroundColor:'rgba(59,130,246,0.60)' },
        { label:`MTD (${WEIGHT.label})`,       data:mData, backgroundColor:'rgba(236,72,153,0.35)' }
      ],
      v => Number(v).toLocaleString('en-IN'),
      raw => `${Number(raw).toLocaleString('en-IN')}`
    );
  })();

  // 3) Avg cost/kg — plain ₹/kg (unit price)
  (function(){
    const labels=(cost||[]).map(x=>x.label);
    const data=(cost||[]).map(x=>Number(x.avg_cost||0));
    const colorMap={RM:"#1f77b4",Melting:"#ff7f0e",Atom:"#2ca02c",Anneal:"#9467bd",Grind:"#8c564b",FG:"#d62728"};
    makeBar(
      'costChart',
      labels,
      [{ label:'Avg Cost/kg (₹)', data, backgroundColor: labels.map(l=>colorMap[l]||"#6b7280") }],
      v => `₹ ${Number(v).toLocaleString('en-IN')}`,
      raw => `₹ ${Number(raw).toLocaleString('en-IN',{maximumFractionDigits:2})}`
    );
  })();

  // 4) WIP Pipeline — dual axis: bars (Qty, left) + line (Value, right)
  (function(){
    const el = document.getElementById('wipChart'); if(!el) return;
    const labels = (wip||[]).map(x=>x.label);
    const qtyBars = (wip||[]).map(x=>weightNumber(x.qty||0, WEIGHT));
    const valLine = (wip||[]).map(x=>moneyNumber(x.value||0, MONEY));

    new Chart(el, {
      data:{
        labels,
        datasets:[
          { type:'bar',  yAxisID:'yQty',  label:`Qty (${WEIGHT.label})`,  data:qtyBars, backgroundColor:'rgba(99,102,241,0.55)' },
          { type:'line', yAxisID:'yVal',  label:`Value (${MONEY.label})`, data:valLine, borderWidth:2, tension:0.25,
            pointRadius:3, pointHoverRadius:4 }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false, layout:{ padding:{ top:16 } },
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{
            label:(ctx)=>{
              const k = ctx.dataset.yAxisID==='yQty'
                ? `${Number(ctx.raw).toLocaleString('en-IN')} ${WEIGHT.label}`
                : `${Number(ctx.raw).toLocaleString('en-IN')} ${MONEY.label}`;
              return `${ctx.dataset.label}: ${k}`;
            }
          }},
          valueLabels:{ formatter:(raw, di)=>`${Number(raw).toLocaleString('en-IN')}` } // labels on bars + points
        },
        scales:{
          yQty:{ position:'left', beginAtZero:true,
                 ticks:{ callback:v=>Number(v).toLocaleString('en-IN') } },
          yVal:{ position:'right', beginAtZero:true, grid:{ drawOnChartArea:false },
                 ticks:{ callback:v=>Number(v).toLocaleString('en-IN') } }
        }
      }
    });
  })();

  // Resize on print to avoid clipping
  window.onbeforeprint = () => {
    if (Chart && Chart.instances) {
      for (const id in Chart.instances) { try { Chart.instances[id].resize(); } catch(e){} }
    }
  };
})();
</script>
{% endblock %}
