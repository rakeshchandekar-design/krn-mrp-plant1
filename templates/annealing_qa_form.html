{% extends "base.html" %}
{% block content %}
{# ---- SAFE DEFAULTS so the page renders even if something is missing ---- #}
{% set has_header = header is defined and header %}
{% set _chem = chem if chem is defined else
  {'C':'','Si':'','S':'','P':'','Cu':'','Ni':'','Mn':'','Fe':''} %}
{% set _phys = phys if phys is defined else {'ad':'','flow':''} %}
{% set _psd  = psd  if psd  is defined else
  {'p212':'','p180':'','n180p150':'','n150p75':'','n75p45':'','n45':''} %}
{% set _qa   = qa   if qa   is defined else {'oxygen':'','decision':'APPROVED','remarks':''} %}

<h2>Anneal QA — {{ has_header and header.lot_no or '' }}</h2>

<div class="toolbar" style="margin:10px 0; display:flex; gap:8px; flex-wrap:wrap">
  <a class="btn" href="/qa-dashboard">← Back to QA Dashboard</a>
  {% if has_header %}
    <a class="btn" href="/anneal/lots">Anneal Lots</a>
    <a class="btn" href="/anneal/trace/{{ header.id }}" target="_blank">Trace</a>
    <a class="btn" href="/anneal/pdf/{{ header.id }}" target="_blank">PDF</a>
  {% endif %}
</div>

<p class="muted">
  {% if has_header %}
    Date: {{ header.date }} |
    Grade: {{ header.grade }} |
    Weight: {{ '%.0f'|format((header.weight_kg or 0) if header.weight_kg is defined else 0) }} kg |
    Ammonia: {{ '%.2f'|format((header.ammonia_kg or 0) if header.ammonia_kg is defined else 0) }} kg
  {% endif %}
</p>

<form method="post" action="/anneal/qa/{{ has_header and header.id or 0 }}">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px">
    <div>
      <h3>Chemistry</h3>
      <table class="table" style="width:auto">
        <tr>
          <th>C</th><td><input name="C"   value="{{ _chem.C }}"></td>
          <th>Si</th><td><input name="Si" value="{{ _chem.Si }}"></td>
        </tr>
        <tr>
          <th>S</th><td><input name="S"   value="{{ _chem.S }}"></td>
          <th>P</th><td><input name="P"   value="{{ _chem.P }}"></td>
        </tr>
        <tr>
          <th>Cu</th><td><input name="Cu" value="{{ _chem.Cu }}"></td>
          <th>Ni</th><td><input name="Ni" value="{{ _chem.Ni }}"></td>
        </tr>
        <tr>
          <th>Mn</th><td><input name="Mn" value="{{ _chem.Mn }}"></td>
          <th>Fe</th><td><input name="Fe" value="{{ _chem.Fe }}"></td>
        </tr>
      </table>
    </div>

    <div>
      <h3>Physical / PSD</h3>
      <table class="table" style="width:auto">
        <tr>
          <th>AD</th><td><input name="ad"   value="{{ _phys.ad }}"></td>
          <th>Flow</th><td><input name="flow" value="{{ _phys.flow }}"></td>
        </tr>
      </table>

      <h4 style="margin-top:10px">PSD</h4>
      <table class="table" style="width:auto">
        <tr><th>+212</th><td><input name="p212" value="{{ _psd.p212 }}"></td></tr>
        <tr><th>+180</th><td><input name="p180" value="{{ _psd.p180 }}"></td></tr>
        <tr><th>-180+150</th><td><input name="n180p150" value="{{ _psd.n180p150 }}"></td></tr>
        <tr><th>-150+75</th><td><input name="n150p75"  value="{{ _psd.n150p75 }}"></td></tr>
        <tr><th>-75+45</th><td><input name="n75p45"   value="{{ _psd.n75p45 }}"></td></tr>
        <tr><th>-45</th><td><input name="n45"        value="{{ _psd.n45 }}"></td></tr>
      </table>
    </div>
  </div>

  <div style="margin-top:12px">
    <h3>Anneal-specific</h3>
    <table class="table" style="width:auto">
      <tr>
        <th>Oxygen</th>
        <td><input name="oxygen" value="{{ _qa.oxygen }}"></td>
        <th>Decision</th>
        <td>
          {% set dec = (_qa.decision or 'APPROVED')|upper %}
          <select name="decision">
            <option value="APPROVED" {{ 'selected' if dec=='APPROVED' else '' }}>APPROVED</option>
            <option value="HOLD"      {{ 'selected' if dec=='HOLD' else '' }}>HOLD</option>
            <option value="REJECTED"  {{ 'selected' if dec=='REJECTED' else '' }}>REJECTED</option>
          </select>
        </td>
      </tr>
      <tr>
        <th>Remarks</th>
        <td colspan="3"><input name="remarks" style="width:100%" value="{{ _qa.remarks }}"></td>
      </tr>
    </table>
  </div>

<div style="margin-top:12px">
  <button class="btn" type="submit">Save QA</button>
  <a class="btn" href="/qa-dashboard">Cancel</a>
  <a class="btn" href="/anneal/trace/{{ header.id }}" target="_blank">Trace</a>
  <a class="btn" href="/anneal/pdf/{{ header.id }}" target="_blank">PDF</a>
</div>

{% if error_text %}
  <p style="color:#b91c1c; margin-top:8px;">{{ error_text }}</p>
{% endif %}  
{% if error_text %}
  <div style="margin-top:8px;color:#b91c1c;font-size:13px;">
    {{ error_text }}
  </div>
{% endif %}

<style>
  .muted{color:#6b7280}
  .table{border-collapse:collapse}
  .table th,.table td{border:1px solid #e5e7eb; padding:6px 8px}
  input{padding:6px 8px; min-width:120px}
  .btn{padding:8px 14px; background:#111827; color:#fff; border-radius:8px; text-decoration:none; border:0}
</style>
{% endblock %}
