<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>QA – Screened Lot</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:20px}
    .brand{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand .name{font-weight:600;font-size:22px;margin:0}
    .brand img{height:40px}
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;color:#fff}
    .badge-success{background:#16a34a}  /* KIP */
    .badge-info{background:#0ea5e9}     /* KFS */
    .sec{margin-top:16px}
    label{display:block;margin-top:6px}
    input{padding:4px 6px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px}
    .btn{margin-top:16px;padding:8px 14px;border-radius:8px;background:#111827;color:#fff;border:none;cursor:pointer}
    a.btn-link{display:inline-block;margin-bottom:10px}
    .muted{color:#6b7280;font-size:12px}
  </style>
  <script>
    // Simple numeric >0 validator for required number inputs
    function validateNumericRequiredPositive(form){
      const nums = form.querySelectorAll('input[type="number"][required]');
      for (const el of nums){
        const v = parseFloat(el.value);
        if (!isFinite(v) || v <= 0){
          alert("All required numeric fields must be > 0.");
          el.focus();
          return false;
        }
      }
      return true;
    }
  </script>
</head>
<body>
  <div class="brand">
    <div class="name">KRN Alloys Pvt. Ltd</div>
    <img src="/static/KRN_Logo.png" alt="KRN">
  </div>

  <h2>QA – Screened Lot {{ lot.lot_no }}
    {% if (lot.grade or 'KIP') == 'KFS' %}<span class="badge badge-info">KFS</span>
    {% else %}<span class="badge badge-success">KIP</span>{% endif %}
  </h2>
  <p class="muted">
    Chemistry is auto-fetched from RAP trace. <strong>C, S, P, Si</strong> must be entered here.
    {% if oxygen_from_anneal is not none %}
      &nbsp;|&nbsp; Annealing Oxygen (for reference): <strong>{{ oxygen_from_anneal }}</strong>
    {% endif %}
  </p>
  <p><a class="btn-link" href="/qa-dashboard">Back</a></p>

  <form method="post" onsubmit="return validateNumericRequiredPositive(this)">
    <!-- Chemistry -->
    <div class="sec">
      <h3>Chemistry</h3>
      <div class="grid">
        <!-- Required to be set at Screening (not prefilled) -->
        <div>
          <label>C</label>
          <input type="number" step="0.001" min="0.0001" name="c" value="{{ chem.c or '' }}" required {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>S</label>
          <input type="number" step="0.001" min="0.0001" name="s" value="{{ chem.s or '' }}" required {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>P</label>
          <input type="number" step="0.001" min="0.0001" name="p" value="{{ chem.p or '' }}" required {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>Si</label>
          <input type="number" step="0.001" min="0.0001" name="si" value="{{ chem.si or '' }}" required {% if read_only %}readonly{% endif %}>
        </div>

        <!-- Prefilled from RAP trace (editable) -->
        <div>
          <label>Cu</label>
          <input type="number" step="0.001" min="0" name="cu" value="{{ chem.cu or '' }}" {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>Ni</label>
          <input type="number" step="0.001" min="0" name="ni" value="{{ chem.ni or '' }}" {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>Mn</label>
          <input type="number" step="0.001" min="0" name="mn" value="{{ chem.mn or '' }}" {% if read_only %}readonly{% endif %}>
        </div>
        <div>
          <label>Fe</label>
          <input type="number" step="0.001" min="0" name="fe" value="{{ chem.fe or '' }}" {% if read_only %}readonly{% endif %}>
        </div>
      </div>
      <p class="muted">Prefill logic: Cu/Ni/Mn/Fe from RAP trace; C/S/P/Si must be entered here.</p>
    </div>

    <!-- Physical -->
    <div class="sec">
      <h3>Physical</h3>
      <div class="grid" style="grid-template-columns:repeat(2,minmax(180px,1fr))">
        <div>
          <label>Compressibility (g/cc)</label>
          <input type="number" step="0.001" min="0.0001" name="compressibility" value="{{ phys.compressibility or '' }}" required {% if read_only %}readonly{% endif %}>
        </div>
      </div>
    </div>

    <!-- Decision -->
    <div class="sec">
      <label>Decision</label>
      <select name="decision" {% if read_only %}disabled{% endif %}>
        <option value="APPROVED" {% if lot.qa_status=='APPROVED' %}selected{% endif %}>APPROVED</option>
        <option value="REJECTED" {% if lot.qa_status=='REJECTED' %}selected{% endif %}>REJECTED</option>
        <option value="HOLD" {% if lot.qa_status=='HOLD' %}selected{% endif %}>HOLD</option>
      </select>

      <label>Remarks</label>
      <input type="text" name="remarks" value="{{ lot.qa_remarks or '' }}" {% if read_only %}readonly{% endif %}>
    </div>

    {% if not read_only %}<button class="btn" type="submit">Save</button>{% endif %}
  </form>
</body>
</html>
