{% extends "base.html" %}

{% block content %}
<div class="page-wrap">
  <h1>Stores – GRN</h1>

  {% set read_only = is_read_only(request) %}

  <!-- Action buttons -->
  <div class="blue-ui" style="margin-bottom:16px;">
    {% if not read_only %}
      <a class="btn" href="/grn/new">New GRN</a>
    {% endif %}
    <a class="btn" href="/">Home</a>
    <a class="btn" href="javascript:void(0)" onclick="goToday()">Today</a>
  </div>

  <!-- Filter form -->
  <form class="inline-form blue-ui" method="get" action="/grn" style="margin-bottom:16px;">
    <input type="hidden" name="report" value="1">
    <label>From</label>
    <input id="start" type="date" name="start" value="{{ start or today_iso }}">
    <label>To</label>
    <input id="end" type="date" name="end" value="{{ end or today_iso }}">
    <button class="btn" type="submit">Fetch</button>
    <button class="btn" type="button" onclick="exportCSV()">Download CSV</button>
  </form>

  <!-- Live Stock Summary -->
  <div class="summary">
    <h3>Live Stock (Remaining &gt; 0)</h3>
    <table>
      <thead>
        <tr>
          <th>RM Type</th>
          <th class="right">Available (kg)</th>
          <th class="right">Remaining Cost (₹)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rm_summary %}
          <tr>
            <td>{{ row.rm_type }}</td>
            <td class="right">{{ '%.1f' % (row.available or 0) }}</td>
            <td class="right">{{ '%.2f' % (row.cost or 0) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- GRN Table -->
  <table>
    <thead>
      <tr>
        <th>GRN No</th>
        <th>Date</th>
        <th>Supplier</th>
        <th>RM Type</th>
        <th class="right">Qty (kg)</th>
        <th class="right">Price (₹/kg)</th>
        <th class="right">Total Price (₹)</th>
        <th class="right">Remaining (kg)</th>
        <th class="right">Remaining Cost (₹)</th>
      </tr>
    </thead>
    <tbody>
      {% for g in grns %}
        {% set total_price = (g.qty or 0.0) * (g.price or 0.0) %}
        {% set remaining_cost = (g.remaining_qty or 0.0) * (g.price or 0.0) %}
        <tr>
          <td>{{ g.grn_no or ('GRN-'+ (g.date|string).replace('-','') + '-' + (g.id|string)) }}</td>
          <td>{{ g.date }}</td>
          <td>{{ g.supplier }}</td>
          <td>{{ g.rm_type }}</td>
          <td class="right">{{ '%.1f' % (g.qty or 0) }}</td>
          <td class="right">{{ '%.2f' % (g.price or 0) }}</td>
          <td class="right">{{ '%.2f' % total_price }}</td>
          <td class="right">{{ '%.1f' % (g.remaining_qty or 0) }}</td>
          <td class="right">{{ '%.2f' % remaining_cost }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if not grns %}
    <p class="muted">No GRNs match this view.</p>
  {% endif %}
</div>

<script>
function goToday(){
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const u = new URL(window.location.href);
  u.searchParams.set('report','1');
  u.searchParams.set('start', iso);
  u.searchParams.set('end', iso);
  window.location.href = u.toString();
}

function exportCSV(){
  const s = document.getElementById('start').value || '{{ today_iso }}';
  const e = document.getElementById('end').value   || '{{ today_iso }}';
  const u = new URL('/grn/export', window.location.origin);
  u.searchParams.set('start', s);
  u.searchParams.set('end', e);
  window.location.href = u.toString();
}
</script>
{% endblock %}
