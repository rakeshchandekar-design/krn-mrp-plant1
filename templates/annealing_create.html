{% extends "base.html" %}
{% block content %}
<h2>Create Annealing Lot (Allocate from Approved RAP)</h2>

<div class="toolbar" style="margin-bottom:10px">
  <a class="btn" href="/anneal/">← Back to Annealing</a>
</div>

{# show error passed as ?err=... #}
{% if err %}
  <div class="alert alert-danger" style="margin:10px 0">{{ err }}</div>
{% endif %}

<form method="post">
  <label>Ammonia used (kg)</label>
  <input type="number" step="0.01" name="ammonia_kg" value="0" required>

  <table class="table">
    <tr>
      <th>RAP Lot</th><th>RAP Grade</th><th>Available (kg)</th>
      <th>RAP Cost/kg (₹)</th><th>Allocate (kg)</th>
    </tr>
    {% for r in rap_rows %}
    <tr class="
        {% if r.grade.startswith('KRIP') %} bg-info-subtle
        {% elif r.grade.startswith('KRFS') %} bg-warning-subtle
        {% endif %}
    ">
      <td>{{ r.lot_no }}</td>
      <td>{{ r.grade }}</td>
      <td>{{ '%.1f'|format(r.available_kg) }}</td>
      <td>{{ '%.2f'|format(r.cost_per_kg or 0) }}</td>
      <td>
        <input class="alloc" type="number" step="0.01" min="0" max="{{ r.available_kg }}" name="alloc_{{ r.lot_no }}">
      </td>
    </tr>
    {% endfor %}
    <!-- Live total row -->
    <tr class="table-info">
      <th colspan="4" style="text-align:right">Total allocated (kg)</th>
      <th><span id="total_alloc">0.00</span></th>
    </tr>
  </table>

  <!-- Lot weight mirrors the total and is read-only to avoid mismatches -->
  <label>Lot Weight (kg)</label>
  <input id="lot_weight" name="lot_weight" type="number" step="0.01" readonly value="0.00">

  <p class="muted" style="margin-top:6px">
    Cost rule: <strong>Anneal Cost/kg = Weighted RAP Cost/kg + ₹10</strong>. KRIP → KIP, KRFS → KFS.
  </p>

  <button class="btn btn-primary" type="submit">Create Lot</button>
</form>

<style>
  .bg-info-subtle { background-color: #e6f4ff; }     /* Light blue for KRIP */
  .bg-warning-subtle { background-color: #fff3e0; }  /* Light orange for KRFS */
</style>

<script>
  (function () {
    const allocInputs = Array.from(document.querySelectorAll('input.alloc'));
    const totalSpan = document.getElementById('total_alloc');
    const lotWeight = document.getElementById('lot_weight');
    const form = document.querySelector('form');

    function recalc() {
      let sum = 0;
      for (const el of allocInputs) {
        const v = parseFloat(el.value || '0');
        if (!isNaN(v)) sum += v;
      }
      totalSpan.textContent = sum.toFixed(2);
      lotWeight.value = sum.toFixed(2);
    }

    allocInputs.forEach(el => el.addEventListener('input', recalc));
    recalc();

    form.addEventListener('submit', function (e) {
      const total = parseFloat(totalSpan.textContent || '0');
      const lw = parseFloat(lotWeight.value || '0');
      if (!total || total <= 0) {
        e.preventDefault();
        alert('Please allocate quantity > 0 kg.');
        return;
      }
      // belt-and-suspenders: ensure the two match (should always be true)
      if (Math.abs(total - lw) > 0.01) {
        e.preventDefault();
        alert(Lot weight mismatch: allocated ${total.toFixed(2)} kg, entered ${lw.toFixed(2)} kg.);
      }
    });
  })();
</script>
{% endblock %}
