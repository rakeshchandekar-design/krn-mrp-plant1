{% extends "base.html" %}
{% block content %}

{# Make sure we have a boolean 'is_admin' even if route forgot to send it #}
{% if is_admin is not defined %}
  {% set is_admin =
    (request.state.is_admin is defined and request.state.is_admin) or
    (request.state.role is defined and request.state.role|string|lower == 'admin') or
    (request.state.roles is defined and 'admin' in request.state.roles)
  %}
{% endif %}

<h2>Create Annealing Lot (Allocate from Approved RAP)</h2>

<div class="toolbar" style="margin-bottom:10px">
  <a class="btn" href="/anneal/">← Back to Annealing</a>
</div>

{% if err %}
  <div class="alert alert-danger" style="margin:10px 0">{{ err }}</div>
{% endif %}

<form method="post" id="createForm">
  <label>Lot Weight (kg)</label>
  <input id="lot_weight" name="lot_weight" type="number" step="0.01" min="0.01" required>

  <label>Ammonia used (kg)</label>
  <input id="ammonia_kg" type="number" step="0.001" min="0" name="ammonia_kg" value="0" required>
  <div class="muted" style="margin:4px 0 10px">
    Minimum ammonia required: <b><span id="nh3_min">0.000</span> kg</b> (0.025 kg per kg of lot weight)
  </div>

  <table class="table">
    <tr>
      <th>RAP Lot</th>
      <th>RAP Grade</th>
      <th>Available (kg)</th>
      {% if is_admin %}<th>RAP Cost/kg (₹)</th>{% endif %}
      {% if is_admin %}<th>Total Value (₹)</th>{% endif %}
      <th>Allocate (kg)</th>
    </tr>

    {% set tv = namespace(sum=0.0) %}
    {% for r in rap_rows %}
    <tr class="
        {% if r.grade.startswith('KRIP') %} bg-info-subtle
        {% elif r.grade.startswith('KRFS') %} bg-warning-subtle
        {% endif %}
    ">
      <td>{{ r.lot_no }}</td>
      <td>{{ r.grade }}</td>
      <td>{{ '%.1f'|format(r.available_kg or 0) }}</td>
      {% if is_admin %}<td>{{ '%.2f'|format(r.cost_per_kg or 0) }}</td>{% endif %}
      {% if is_admin %}
        <td>
          {% set row_value = (r.available_kg or 0) * (r.cost_per_kg or 0) %}
          {{ '%.2f'|format(row_value) }}
          {% set tv.sum = tv.sum + row_value %}
        </td>
      {% endif %}
      <td>
        <input
          type="number" step="0.01" min="0" max="{{ r.available_kg }}"
          name="alloc_{{ r.lot_no }}"
          data-grade="{{ r.grade }}">
      </td>
    </tr>
    {% endfor %}

    <tr class="table-info">
      <th colspan="{{ 3 + (1 if is_admin else 0) }}" style="text-align:right">Totals:</th>
      {% if is_admin %}<th><span id="total_value_sum">{{ '%.2f'|format(tv.sum) }}</span></th>{% endif %}
      <th><span id="total_alloc">0.00</span></th>
    </tr>
  </table>

  <div id="client_err" class="alert alert-danger" style="display:none;margin:10px 0"></div>

  <p class="muted" style="margin-top:6px">
    Cost rule: <strong>Anneal Cost/kg = Weighted RAP Cost/kg + ₹10</strong>. KRIP → KIP, KRFS → KFS.
  </p>

  <button id="submitBtn" class="btn btn-primary" type="submit" disabled>Create Lot</button>
</form>

<style>
  .bg-info-subtle { background-color: #e6f4ff; }
  .bg-warning-subtle { background-color: #fff3e0; }
</style>

<script>
(function () {
  const form = document.getElementById('createForm');
  const lotWeightEl = document.getElementById('lot_weight');
  const ammoniaEl = document.getElementById('ammonia_kg');
  const nh3MinSpan = document.getElementById('nh3_min');
  const totalSpan = document.getElementById('total_alloc');
  const errBox = document.getElementById('client_err');
  const submitBtn = document.getElementById('submitBtn');

  const allocInputs = Array.from(document.querySelectorAll('input[name^="alloc_"]'));

  function sumAlloc() {
    let s = 0;
    for (const el of allocInputs) {
      const v = parseFloat(el.value);
      if (!isNaN(v)) s += v;
    }
    return s;
  }

  function allocatedGrades() {
    const g = new Set();
    for (const el of allocInputs) {
      const v = parseFloat(el.value);
      if (!isNaN(v) && v > 0) g.add(el.dataset.grade || '');
    }
    return g;
  }

  function fmt(n, d=2) { return (isFinite(n) ? n : 0).toFixed(d); }

  function recompute() {
    const total = sumAlloc();
    totalSpan.textContent = fmt(total, 2);

    const lw = parseFloat(lotWeightEl.value);
    const nh3Min = (isFinite(lw) ? lw * 0.025 : 0);
    nh3MinSpan.textContent = fmt(nh3Min, 3);

    let msg = '';
    if (!isFinite(lw) || lw <= 0) {
      msg = 'Enter Lot Weight (> 0).';
    } else if (Math.abs(total - lw) > 0.01) {
      msg = `Lot Weight must equal total allocated (diff ${fmt(Math.abs(total-lw),2)} kg).`;
    } else if (allocatedGrades().size > 1) {
      msg = 'Only one grade may be allocated per anneal lot.';
    } else {
      const nh3 = parseFloat(ammoniaEl.value || '0');
      if (nh3 < nh3Min) {
        msg = `Ammonia must be at least ${fmt(nh3Min,3)} kg.`;
      }
    }

    if (msg) {
      errBox.style.display = '';
      errBox.textContent = msg;
      submitBtn.disabled = true;
    } else {
      errBox.style.display = 'none';
      submitBtn.disabled = false;
    }
  }

  allocInputs.forEach(el => el.addEventListener('input', recompute));
  lotWeightEl.addEventListener('input', recompute);
  ammoniaEl.addEventListener('input', recompute);

  form.addEventListener('submit', function (e) {
    recompute();
    if (submitBtn.disabled) e.preventDefault();
  });

  recompute();
})();
</script>
{% endblock %}
