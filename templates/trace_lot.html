<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Traceability – Lot {{ lot.lot_no }}</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif; margin:20px;}
    a.btn-link{display:inline-block;margin-bottom:10px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #e5e7eb; padding:8px; text-align:left}
    th{background:#f3f4f6}
    .right{text-align:right}
  </style>
</head>
<body>
  <h1>Traceability – Lot {{ lot.lot_no }}</h1>
  <p><a class="btn-link" href="/atomization">Back</a></p>

  <!-- Heats used in this lot with allocated quantity -->
  <h3>Heats in Lot (with allocation)</h3>
  <ul>
    {% for h in heats %}
      <li>
        {{ h.heat_no }}
        – Allocated to this lot:
        <strong>{{ '%.1f' % (alloc_map.get(h.id, 0.0) or 0) }}</strong> kg
        (Heat Output: {{ '%.1f' % (h.actual_output or 0) }} kg)
      </li>
    {% endfor %}
  </ul>

  <!-- FIFO GRN breakdown (unchanged) -->
  <h3>GRN Consumption (FIFO)</h3>
  <table>
    <thead>
      <tr>
        <th>Heat</th>
        <th>RM Type</th>
        <th>GRN #</th>
        <th>Supplier</th>
        <th class="right">Qty (kg)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in grn_rows %}
      <tr>
        <td>{{ r.heat_no }}</td>
        <td>{{ r.rm_type }}</td>
        <td>{{ r.grn_id }}</td>
        <td>{{ r.supplier }}</td>
        <td class="right">{{ '%.1f' % (r.qty or 0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>
