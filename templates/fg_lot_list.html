{% extends "base.html" %}
{% block content %}
<h2>FG Lots</h2>
<div class="toolbar" style="margin-bottom:10px; gap:8px; display:flex; flex-wrap:wrap; align-items:center">
  <a class="btn" href="/fg/">← Back to FG</a>
  <form method="get" action="/fg/lots" style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
    <label>From</label><input type="date" name="from_date" value="{{ from_date or '' }}">
    <label>To</label><input type="date" name="to_date" value="{{ to_date or '' }}">
    <button class="btn" type="submit">Fetch</button>
    <a class="btn" href="/fg/lots?from_date={{ today }}&to_date={{ today }}">Today</a>
    <a class="btn" href="/fg/lots">Reset</a>
    <a class="btn" href="/fg/lots?csv=1{% if from_date %}&from_date={{ from_date }}{% endif %}{% if to_date %}&to_date={{ to_date }}{% endif %}">Download CSV</a>
  </form>
</div>

<table class="table">
  <tr>
    <th>Date</th><th>Lot</th><th>Family</th><th>FG Grade</th><th>Weight (kg)</th>
    {% set admin = request.state.role is defined and request.state.role|string == 'admin' %}
    {% if admin %}
      <th>Base ₹/kg</th><th>Surcharge ₹/kg</th><th>Final ₹/kg</th>
    {% endif %}
    <th>QA</th><th>Docs</th><th>Action</th>
  </tr>
  {% for x in lots %}
  <tr>
    <td>{{ x.date }}</td>
    <td>{{ x.lot_no }}</td>
    <td>{{ x.family }}</td>
    <td>{{ x.fg_grade }}</td>
    <td>{{ '%.0f'|format(x.weight_kg or 0) }}</td>
    {% if admin %}
      <td>{{ '%.2f'|format(x.base_cost_per_kg or 0) }}</td>
      <td>{{ '%.2f'|format(x.surcharge_per_kg or 0) }}</td>
      <td>{{ '%.2f'|format(x.cost_per_kg or 0) }}</td>
    {% endif %}
    <td>{{ x.qa_status or '' }}</td>
    <td>
      <a href="/fg/trace/{{ x.id }}">Trace</a> |
      <a href="/fg/pdf/{{ x.id }}" target="_blank">PDF</a>
    </td>
    <td><a class="btn btn-small" href="/fg/qa/{{ x.id }}">QA</a></td>
  </tr>
  {% endfor %}
  <tr class="table-info">
    <th colspan="4">TOTAL</th>
    <th>{{ '%.2f'|format(total_weight or 0) }}</th>
    {% if admin %}<th colspan="2"></th><th>{{ '%.2f'|format(weighted_cost or 0) }}</th>{% endif %}
    <th colspan="3"></th>
  </tr>
</table>
{% endblock %}
