<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RAP – Ready After Atomization</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .brand { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .brand .name { font-weight: 600; font-size: 26px; line-height: 48px; margin: 0; }
    .brand img { height: 48px; }
    /* … rest unchanged … */
  </style>
</head>
<body>
  {% set read_only = is_read_only(request) %}
  <div class="brand">
    <div class="name">KRN Alloys Pvt. Ltd</div>
    <img src="/static/KRN_Logo.png" alt="KRN">
  </div>

  <h1>RAP – Ready After Atomization</h1>
  <p class="toolbar-head">
    <a class="btn ghost" href="/">Home</a>
  </p>

  <!-- KPIs + MTD + balance unchanged -->

  <!-- Create Dispatch Note -->
  <div class="card">
    <h3>Create Dispatch Note (Multi-lot)</h3>
    <form id="dispatchForm" method="post" action="/rap/dispatch/save">
      <fieldset {% if read_only %}disabled{% endif %}>
        <!-- existing inputs + table unchanged -->

        {% if not read_only %}
          <button class="btn" type="submit">Generate Dispatch Note</button>
        {% else %}
          <p class="muted">Read-only: Dispatch note creation disabled.</p>
        {% endif %}
      </fieldset>
    </form>
  </div>

  <!-- RAP Lots – Transfers to Plant 2 -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">RAP Lots – Transfers to Plant 2</h2>
    <table>
      <thead>
        <tr>
          <th>Lot</th><th>Grade</th><th class="right">Lot Weight (kg)</th>
          <th class="right">Available (kg)</th>
          {% if role == 'admin' %}<th class="right">Cost/kg (₹)</th>{% endif %}
          <th class="right">Value (₹)</th>
          <th>Docs</th>
          <th>Allocate</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows if (r.available_qty or 0) > 0 %}
          {% set lot = r.lot %}
          <tr>
            <td>{{ lot.lot_no }}</td>
            <td>{% if (lot.grade or 'KRIP') == 'KRFS' %}<span class="badge badge-info">KRFS</span>{% else %}<span class="badge badge-success">KRIP</span>{% endif %}</td>
            <td class="right">{{ '%.1f' % (lot.weight or 0) }}</td>
            <td class="right">{{ '%.1f' % (r.available_qty or 0) }}</td>
            {% if role == 'admin' %}<td class="right">{{ '%.2f' % (lot.unit_cost or 0) }}</td>{% endif %}
            <td class="right">{% if role == 'admin' %}{{ '%.2f' % ((lot.unit_cost or 0) * (r.available_qty or 0)) }}{% else %}—{% endif %}</td>
            <td>
              <a href="/lot/{{ lot.id }}/trace" target="_blank">Trace</a> |
              <a href="/lot/{{ lot.id }}/pdf" target="_blank">PDF</a> |
              <a href="/lot/{{ lot.id }}/qa" target="_blank">QA</a>
            </td>
            <td>
              {% if not read_only %}
                <form method="post" action="/rap/allocate" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                  <input type="hidden" name="rap_lot_id" value="{{ r.id }}">
                  <input type="hidden" name="kind" value="PLANT2">
                  <input type="date" name="date" max="{{ today }}" min="{{ min_date }}" required>
                  <input type="number" step="0.1" min="0" max="{{ '%.1f' % (r.available_qty or 0) }}" name="qty" placeholder="Qty (kg)" required>
                  <input type="text" name="remarks" placeholder="remarks">
                  <button class="btn" type="submit">Allocate</button>
                </form>
              {% else %}
                <p class="muted">Read-only: Allocation disabled.</p>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not rows %}
      <p class="muted">No APPROVED lots are available in RAP.</p>
    {% endif %}
  </div>
</body>
</html>
