<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RAP – Ready After Atomization</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .brand { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .brand .name { font-weight: 600; font-size: 26px; line-height: 48px; margin: 0; }
    .brand img { height: 48px; }

    .toolbar-head { margin: 6px 0 12px; display: flex; gap: 8px; flex-wrap: wrap; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
    .card h3 { margin: 0 0 8px 0; font-size: 14px; }

    .btn { padding: 8px 14px; border-radius: 8px; background: #111827; color: #fff; border: none; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn.ghost { background: #e5e7eb; color: #111827; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
    th { background: #f3f4f6; }
    .right { text-align: right; }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #fff; }
    .badge-success { background: #16a34a; }
    .badge-info { background: #0ea5e9; }

    .muted { color: #6b7280; font-size: 12px; }
    .toolbar { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

    input, select { padding: 4px 6px; }
  </style>
</head>
<body>
  <div class="brand">
    <div class="name">KRN Alloys Pvt. Ltd</div>
    <img src="/static/KRN_Logo.png" alt="KRN">
  </div>

  <h1>RAP – Ready After Atomization</h1>
  <p class="toolbar-head">
    <a class="btn ghost" href="/">Home</a>
  </p>

  <!-- Row 1: KPIs -->
  <div class="grid">
    <div class="card">
      <h3>RAP KPIs</h3>
      <table style="width:auto">
        <thead>
          <tr><th>Grade</th><th class="right">Available (kg)</th><th class="right">Value (₹)</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>KRIP</td>
            <td class="right">{{ '%.1f' % (kpi.KRIP_qty or 0) }}</td>
            <td class="right">{{ '%.2f' % (kpi.KRIP_val or 0) }}</td>
          </tr>
          <tr>
            <td>KRFS</td>
            <td class="right">{{ '%.1f' % (kpi.KRFS_qty or 0) }}</td>
            <td class="right">{{ '%.2f' % (kpi.KRFS_val or 0) }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th>Total</th>
            <th class="right">{{ '%.1f' % ((kpi.KRIP_qty or 0) + (kpi.KRFS_qty or 0)) }}</th>
            <th class="right">{{ '%.2f' % ((kpi.KRIP_val or 0) + (kpi.KRFS_val or 0)) }}</th>
          </tr>
        </tfoot>
      </table>
      <div class="muted">RAP available = Approved lot weight − allocations (Dispatch/Plant 2).</div>
    </div>

    <div class="card">
      <h3>This Month – Cumulative Movements</h3>
      <table style="width:auto">
        <thead>
          <tr><th>Type</th><th class="right">KRIP (kg)</th><th class="right">KRFS (kg)</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Dispatch</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['DISPATCH']['KRIP'] if kpi_trends and kpi_trends.get('DISPATCH') else 0) or 0) }}</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['DISPATCH']['KRFS'] if kpi_trends and kpi_trends.get('DISPATCH') else 0) or 0) }}</td>
          </tr>
          <tr>
            <td>Plant 2</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['PLANT2']['KRIP'] if kpi_trends and kpi_trends.get('PLANT2') else 0) or 0) }}</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['PLANT2']['KRFS'] if kpi_trends and kpi_trends.get('PLANT2') else 0) or 0) }}</td>
          </tr>
        </tbody>
      </table>
      <p class="toolbar">
        <a class="btn" href="/rap/dispatch/export">Download Dispatch Movements (CSV)</a>
        <a class="btn ghost" href="/rap/transfer/export">Download Plant-2 Transfers (CSV)</a>
      </p>
    </div>
  </div>

  <!-- Atomization Balance -->
  {% set M = atom_mtd or {'feed': 0, 'rap': 0, 'oversize': 0, 'conv': 0} %}
  <div class="card" style="margin-top:12px">
    <h3>Atomization Balance — Month to Date</h3>
    <table style="width:auto">
      <thead>
        <tr><th>Metric</th><th class="right">Kg</th></tr>
      </thead>
      <tbody>
        <tr><td>Feed from Melting</td><td class="right">{{ '%.1f' % (M.get('feed', 0) or 0) }}</td></tr>
        <tr><td>RAP Produced</td><td class="right">{{ '%.1f' % (M.get('rap', 0) or 0) }}</td></tr>
        <tr><td>+20 / Dryer Oversize</td><td class="right">{{ '%.1f' % (M.get('oversize', 0) or 0) }}</td></tr>
      </tbody>
      <tfoot>
        <tr><th>Conversion to RAP</th><th class="right">{{ '%.1f' % (M.get('conv', 0) or 0) }}%</th></tr>
      </tfoot>
    </table>
    <div class="muted">Feed = sum of heat allocations into lots created this month.</div>
  </div>

  <!-- Dispatch Note -->
  <div class="card">
    <h3>Create Dispatch Note (Multi-lot)</h3>
    <!-- form unchanged -->
    {{!-- your dispatch form block remains here --}}
  </div>

  <!-- Transfers to Plant 2 -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">RAP Lots – Transfers to Plant 2</h2>
    <table>
      <thead>
        <tr>
          <th>Lot</th>
          <th>Grade</th>
          <th class="right">Lot Weight (kg)</th>
          <th class="right">Available (kg)</th>
          {% if role == 'admin' %}<th class="right">Cost/kg (₹)</th>{% endif %}
          <th class="right">Value (₹)</th>
          <th>Docs</th>
          <th>Allocate</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows if (r.available_qty or 0) > 0 %}
          {% set lot = r.lot %}
          <tr>
            <td>{{ lot.lot_no }}</td>
            <td>
              {% if (lot.grade or 'KRIP') == 'KRFS' %}
                <span class="badge badge-info">KRFS</span>
              {% else %}
                <span class="badge badge-success">KRIP</span>
              {% endif %}
            </td>
            <td class="right">{{ '%.1f' % (lot.weight or 0) }}</td>
            <td class="right">{{ '%.1f' % (r.available_qty or 0) }}</td>
            {% if role == 'admin' %}
              <td class="right">{{ '%.2f' % (lot.unit_cost or 0) }}</td>
            {% endif %}
            <td class="right">
              {% if role == 'admin' %}
                {{ '%.2f' % ((lot.unit_cost or 0) * (r.available_qty or 0)) }}
              {% else %}
                {{ '%.2f' % (r.available_qty or 0) }}
              {% endif %}
            </td>
            <td>
              <a href="/lot/{{ lot.id }}/trace" target="_blank">Trace</a> |
              <a href="/lot/{{ lot.id }}/pdf" target="_blank">PDF</a> |
              <a href="/lot/{{ lot.id }}/qa" target="_blank">QA</a>
            </td>
            <td>
              <form method="post" action="/rap/allocate" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                <input type="hidden" name="rap_lot_id" value="{{ r.id }}">
                <input type="hidden" name="kind" value="PLANT2">
                <input type="date" name="date" max="{{ today }}" min="{{ min_date }}" required>
                <input type="number" step="0.1" min="0" max="{{ '%.1f' % (r.available_qty or 0) }}" name="qty" placeholder="Qty (kg)" required>
                <input type="text" name="remarks" placeholder="remarks">
                <button class="btn" type="submit">Allocate</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not rows %}
      <p class="muted">No APPROVED lots are available in RAP.</p>
    {% endif %}
  </div>
</body>
</html>
