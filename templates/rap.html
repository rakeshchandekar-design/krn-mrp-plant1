{% extends "base.html" %}
{% block content %}
{% set read_only = is_read_only(request) %}
<div class="page-wrap" style="max-width:1200px;margin:16px auto;padding:0 16px">

  <h1>RAP – Ready After Atomization</h1>

  <!-- Row 1: KPIs (left) + Month-to-date (right) -->
  <div class="grid-2">
    <div class="card">
      <h3>RAP KPIs</h3>
      <table style="width:auto">
        <thead>
          <tr><th>Grade</th><th class="right">Available (kg)</th><th class="right">Value (₹)</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>KRIP</td>
            <td class="right">{{ '%.1f' % (kpi.KRIP_qty or 0) }}</td>
            <td class="right">{{ '%.2f' % (kpi.KRIP_val or 0) }}</td>
          </tr>
          <tr>
            <td>KRFS</td>
            <td class="right">{{ '%.1f' % (kpi.KRFS_qty or 0) }}</td>
            <td class="right">{{ '%.2f' % (kpi.KRFS_val or 0) }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th>Total</th>
            <th class="right">{{ '%.1f' % ((kpi.KRIP_qty or 0) + (kpi.KRFS_qty or 0)) }}</th>
            <th class="right">{{ '%.2f' % ((kpi.KRIP_val or 0) + (kpi.KRFS_val or 0)) }}</th>
          </tr>
        </tfoot>
      </table>
      <div class="small">RAP available = Approved lot weight − allocations (Dispatch/Plant-2).</div>
    </div>

    <div class="card">
      <h3>This Month – Cumulative Movements</h3>
      <table style="width:auto">
        <thead>
          <tr><th>Type</th><th class="right">KRIP (kg)</th><th class="right">KRFS (kg)</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Dispatch</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['DISPATCH']['KRIP'] if kpi_trends and kpi_trends.get('DISPATCH') else 0) or 0) }}</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['DISPATCH']['KRFS'] if kpi_trends and kpi_trends.get('DISPATCH') else 0) or 0) }}</td>
          </tr>
          <tr>
            <td>Plant 2</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['PLANT2']['KRIP'] if kpi_trends and kpi_trends.get('PLANT2') else 0) or 0) }}</td>
            <td class="right">{{ '%.1f' % ((kpi_trends['PLANT2']['KRFS'] if kpi_trends and kpi_trends.get('PLANT2') else 0) or 0) }}</td>
          </tr>
        </tbody>
      </table>

      <p class="toolbar" style="margin-top:10px">
        <a class="btn" href="/rap/dispatch/export">Download Dispatch Movements (CSV)</a>
        <a class="btn btn-secondary" style="background:#e5e7eb;color:#111827;border:none" href="/rap/transfer/export">Download Plant-2 Transfers (CSV)</a>
      </p>
    </div>
  </div>

  <!-- Atomization Balance -->
  {% set M = atom_mtd or {'feed': 0, 'rap': 0, 'oversize': 0, 'conv': 0} %}
  <div class="card" style="margin-top:12px">
    <h3>Atomization Balance — Month to Date</h3>
    <table style="width:auto">
      <thead>
        <tr><th>Metric</th><th class="right">Kg</th></tr>
      </thead>
      <tbody>
        <tr><td>Feed from Melting</td><td class="right">{{ '%.1f' % (M.get('feed', 0) or 0) }}</td></tr>
        <tr><td>RAP Produced</td><td class="right">{{ '%.1f' % (M.get('rap', 0) or 0) }}</td></tr>
        <tr><td>+20 / Dryer Oversize</td><td class="right">{{ '%.1f' % (M.get('oversize', 0) or 0) }}</td></tr>
      </tbody>
      <tfoot>
        <tr><th>Conversion to RAP</th><th class="right">{{ '%.1f' % (M.get('conv', 0) or 0) }}%</th></tr>
      </tfoot>
    </table>
    <div class="small">Feed = sum of heat allocations into lots created this month.</div>
  </div>

  <!-- Create Dispatch Note -->
  <div class="card">
    <h3>Create Dispatch Note (Multi-lot)</h3>

    <form id="dispatchForm" class="blue-ui" method="post" action="/rap/dispatch/save">
      <fieldset {% if read_only %}disabled{% endif %}>
        <div class="toolbar" style="gap:12px">
          <label>Date
            <input type="date" name="date" value="{{ today }}" max="{{ today }}" min="{{ min_date }}" required>
          </label>
          <label>Customer
            <input type="text" name="customer" required>
          </label>
          <label>Total Dispatch Qty (kg)
            <input type="number" step="0.1" min="0" name="total_qty" id="total_qty" placeholder="e.g. 250.0" required>
          </label>
        </div>

        <table>
          <thead>
            <tr>
              <th>Select</th>
              <th>Lot</th>
              <th>Grade</th>
              <th class="right">Available</th>
              <th>Qty to Dispatch</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows if (r.available_qty or 0) > 0 %}
            <tr>
              <td><input type="checkbox" class="pick" name="lot_ids" value="{{ r.id }}"></td>
              <td>{{ r.lot.lot_no }}</td>
              <td>
                {% if (r.lot.grade or 'KRIP') == 'KRFS' %}
                  <span class="badge badge-krfs">KRFS</span>
                {% else %}
                  <span class="badge badge-krip">KRIP</span>
                {% endif %}
              </td>
              <td class="right">{{ '%.1f' % (r.available_qty or 0) }}</td>
              <td>
                <input type="number"
                       class="dq"
                       step="0.1"
                       min="0"
                       max="{{ '%.1f' % (r.available_qty or 0) }}"
                       name="qty_{{ r.id }}"
                       placeholder="Qty">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if not read_only %}
          <button class="btn" type="submit" style="margin-top:10px">Generate Dispatch Note</button>
        {% else %}
          <p class="small" style="margin-top:10px">Read-only: dispatch creation is disabled for viewer role.</p>
        {% endif %}
      </fieldset>
    </form>

    <!-- client-side checks (unchanged logic) -->
    <script>
      (function () {
        const form = document.getElementById('dispatchForm');
        if (!form) return;
        const totalEl = document.getElementById('total_qty');

        function selectedRows() {
          const out = [];
          document.querySelectorAll('input.pick').forEach(cb => {
            if (cb.checked) {
              const row = cb.closest('tr');
              const qtyEl = row.querySelector('input.dq');
              const gradePill = row.querySelector('.badge-krip, .badge-krfs');
              const grade = gradePill ? gradePill.textContent.trim() : 'KRIP';
              out.push({ qty: parseFloat(qtyEl.value || '0'), grade });
            }
          });
          return out;
        }

        form.addEventListener('submit', function (e) {
          {% if read_only %}
          e.preventDefault();
          alert('Read-only role: cannot create dispatch notes.');
          return;
          {% endif %}

          const picks = selectedRows();
          if (picks.length === 0) { e.preventDefault(); alert('Select at least one lot.'); return; }
          for (const p of picks) {
            if (!(p.qty > 0)) { e.preventDefault(); alert('Enter quantity for every selected lot.'); return; }
          }
          const gset = new Set(picks.map(p => p.grade));
          if (gset.size > 1) { e.preventDefault(); alert('Please select lots of a single grade (KRIP or KRFS) in one dispatch.'); return; }

          const want = parseFloat(totalEl.value || '0');
          const have = picks.reduce((s, p) => s + p.qty, 0);
          if (!(want > 0)) { e.preventDefault(); alert('Enter Total Dispatch Qty.'); return; }
          if (Math.abs(want - have) > 0.05) {
            e.preventDefault();
            alert(`Total Dispatch Qty (${want.toFixed(1)}) must equal the sum of selected lot quantities (${have.toFixed(1)}).`);
          }
        });
      })();
    </script>
  </div>

  <!-- RAP Lots – Transfers to Plant 2 -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">RAP Lots – Transfers to Plant 2</h2>
    <table>
      <thead>
        <tr>
          <th>Lot</th>
          <th>Grade</th>
          <th class="right">Lot Weight (kg)</th>
          <th class="right">Available (kg)</th>
          {% if role == 'admin' %}<th class="right">Cost/kg (₹)</th>{% endif %}
          <th class="right">Value (₹)</th>
          <th>Docs</th>
          <th>Allocate</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows if (r.available_qty or 0) > 0 %}
          {% set lot = r.lot %}
          <tr>
            <td>{{ lot.lot_no }}</td>
            <td>
              {% if (lot.grade or 'KRIP') == 'KRFS' %}
                <span class="badge badge-krfs">KRFS</span>
              {% else %}
                <span class="badge badge-krip">KRIP</span>
              {% endif %}
            </td>
            <td class="right">{{ '%.1f' % (lot.weight or 0) }}</td>
            <td class="right">{{ '%.1f' % (r.available_qty or 0) }}</td>
            {% if role == 'admin' %}
              <td class="right">{{ '%.2f' % (lot.unit_cost or 0) }}</td>
            {% endif %}
            <td class="right">
              {% if role == 'admin' %}
                {{ '%.2f' % ((lot.unit_cost or 0) * (r.available_qty or 0)) }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <a href="/lot/{{ lot.id }}/trace" target="_blank">Trace</a> |
              <a href="/lot/{{ lot.id }}/pdf" target="_blank">PDF</a> |
              <a href="/lot/{{ lot.id }}/qa" target="_blank">QA</a>
            </td>
            <td>
              <form method="post" action="/rap/allocate" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                <fieldset {% if read_only %}disabled{% endif %} style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;border:none;margin:0;padding:0">
                  <input type="hidden" name="rap_lot_id" value="{{ r.id }}">
                  <input type="hidden" name="kind" value="PLANT2">
                  <input type="date" name="date" max="{{ today }}" min="{{ min_date }}" required>
                  <input type="number" step="0.1" min="0" max="{{ '%.1f' % (r.available_qty or 0) }}" name="qty" placeholder="Qty (kg)" required>
                  <input type="text" name="remarks" placeholder="remarks">
                  {% if not read_only %}
                    <button class="btn" type="submit">Allocate</button>
                  {% endif %}
                </fieldset>
                {% if read_only %}<span class="small">Read-only</span>{% endif %}
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not rows %}
      <p class="small">No APPROVED lots are available in RAP.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
