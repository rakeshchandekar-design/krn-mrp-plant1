<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Melting</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif; margin:20px;}
    .sec{margin-bottom:24px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #e5e7eb; padding:8px; text-align:left}
    th{background:#f3f4f6}
    .badge{display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; color:#fff}
    .badge-success{background:#16a34a}
    .badge-info{background:#0ea5e9}
    input,select{padding:4px 6px}
    .btn{padding:8px 14px; border-radius:8px; background:#111827; color:#fff; border:none; cursor:pointer}
    a.btn-link{display:inline-block;margin-left:8px}
    /* NEW: header toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 16px}
    .toolbar input{padding:4px 6px}
    .toolbar .btn{background:#fff;color:#111827;border:1px solid #d1d5db}
    /* NEW: compact two-column summary */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{border:1px solid #e5e7eb;border-radius:8px;padding:10px}
    .small{font-size:12px;color:#6b7280}
    .right{text-align:right}
  </style>
  <script>
    function goToday(){
      const d=new Date(); const iso=d.toISOString().slice(0,10);
      const u=new URL(window.location.href);
      u.searchParams.set('report','1');
      u.searchParams.set('start', iso);
      u.searchParams.set('end', iso);
      window.location.href=u.toString();
    }
    function exportCSV(){
      const s=document.getElementById('start').value || '{{ start or today_iso }}';
      const e=document.getElementById('end').value   || '{{ end or today_iso }}';
      const u=new URL('/melting/export', window.location.origin);
      if(s) u.searchParams.set('start', s);
      if(e) u.searchParams.set('end', e);
      window.location.href=u.toString();
    }
  </script>
</head>
<body>
  <h1>Melting</h1>
  <p><a class="btn-link" href="/">Home</a></p>

  <!-- NEW: Top summary row -->
  <div class="grid2 sec">
    <div class="card">
      <b>Power KPI (Today)</b>
      <div class="small">Target: {{ '%.0f' % (power_summary.target_kwh_per_ton or 0) }} kWh/ton</div>
      <table style="width:auto;margin-top:8px">
        <tr><th>Average kWh/ton</th><th>Gap vs Target</th></tr>
        {% set today_avg = power_summary.today_avg_kwh_per_ton or 0 %}
        <tr>
          <td class="right">{{ '%.1f' % today_avg }}</td>
          <td class="right">{{ '%.1f' % (today_avg - (power_summary.target_kwh_per_ton or 0)) }}</td>
        </tr>
      </table>
    </div>

    <div class="card">
      <b>Production â€“ Last 5 Days</b>
      <table style="margin-top:8px">
        <thead><tr><th>Date</th><th class="right">Actual (kg)</th><th class="right">Target (kg)</th><th class="right">Eff.%</th></tr></thead>
        <tbody>
          {% for r in prod_summary %}
            <tr>
              <td>{{ r.date }}</td>
              <td class="right">{{ '%.0f' % (r.actual or 0) }}</td>
              <td class="right">{{ '%.0f' % (r.target or 0) }}</td>
              <td class="right">{{ '%.1f' % (r.eff or 0) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="small">Daily target is adjusted for logged downtime.</div>
    </div>
  </div>

  <!-- NEW: Report toolbar (today + date range + CSV) -->
  <div class="toolbar">
    <button class="btn" type="button" onclick="goToday()">Today</button>
    <form method="get" action="/melting" style="display:inline-flex;gap:8px;align-items:center">
      <input type="hidden" name="report" value="1">
      <label>From</label>
      <input id="start" type="date" name="start" value="{{ start or today_iso }}">
      <label>To</label>
      <input id="end" type="date" name="end" value="{{ end or today_iso }}">
      <button class="btn" type="submit">Fetch</button>
      <button class="btn" type="button" onclick="exportCSV()">Download CSV</button>
    </form>
  </div>

  <div class="sec">
    <h2>New Heat</h2>
    <form method="post" action="/melting/new">
      <div><label>Notes</label><input type="text" name="notes"></div>
      <div><label>Slag Qty (kg)</label><input type="number" step="0.1" name="slag_qty" value="0.0"></div>

      <!-- NEW: optional power input -->
      <div><label>Power (kWh) <span class="small">(optional)</span></label>
        <input type="number" step="0.1" name="power_kwh" placeholder="e.g., 1650.0">
      </div>

      <h3>Raw Materials (up to 4 lines)</h3>
      <div class="small">Enter <b>at least 2</b> RM lines (server enforces). The other lines are optional.</div>
      {% for i in [1,2,3,4] %}
        <div>
          <select name="rm_type_{{ i }}">
            <option value="">-- RM Type --</option>
            {% for t in rm_types %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
          <input type="number" step="0.1" name="rm_qty_{{ i }}" placeholder="Qty (kg)">
        </div>
      {% endfor %}
      <p><button class="btn" type="submit">Create Heat</button></p>
    </form>
  </div>

  <div class="sec">
    <h2>Heats</h2>
    <table>
      <thead><tr><th>Heat</th><th>Type</th><th>Output (kg)</th><th>QA</th><th>Actions</th></tr></thead>
      <tbody>
        {% for h in pending %}
          <tr>
            <td>{{ h.heat_no }}</td>
            <td>
              {% set g = heat_grades.get(h.id) %}
              {% if g == 'KRFS' %}<span class="badge badge-info">KRFS (FeSi)</span>
              {% else %}<span class="badge badge-success">KRIP</span>{% endif %}
            </td>
            <td>{{ '%.1f' % (h.actual_output or 0) }}</td>
            <td>{{ h.qa_status }}</td>
            <td><a href="/qa/heat/{{ h.id }}">QA</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
